<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VaultChain: Ultra-Secure Access Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Inter',sans-serif;background-color:#0d1117;color:#e6edf3;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}.container{background-color:#161b22;border-radius:1rem;padding:2.5rem;box-shadow:0 10px 15px rgba(0,0,0,.3);max-width:700px;width:100%;border:1px solid #30363d}.section{display:none}.section.active{display:block}input[type=text],input[type=password],input[type=email]{background-color:#0d1117;border:1px solid #30363d;color:#e6edf3;padding:.75rem 1rem;border-radius:.5rem;width:100%;transition:border-color .2s}input[type=text]:focus,input[type=password]:focus,input[type=email]:focus{border-color:#58a6ff;outline:none}button{background-color:#238636;color:#fff;padding:.75rem 1.5rem;border-radius:.5rem;font-weight:600;transition:background-color .2s,transform .1s;box-shadow:0 4px 6px rgba(0,0,0,.2);border:none;cursor:pointer}button:hover{background-color:#2ea043;transform:translateY(-1px)}button:active{transform:translateY(0)}button.secondary{background-color:#30363d}button.secondary:hover{background-color:#444c56}button.danger{background-color:#da3633}button.danger:hover{background-color:#f85149}.message-box{background-color:#21262d;border:1px solid #30363d;border-radius:.5rem;padding:1rem;margin-top:1rem;text-align:center}.message-box.success{border-color:#238636;color:#3fb950}.message-box.error{border-color:#da3633;color:#f85149}.message-box.info{border-color:#58a6ff;color:#58a6ff}.spinner{border:4px solid rgba(255,255,255,.3);border-top:4px solid #58a6ff;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin:0 auto}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Connection Screen -->
        <div id="metamask-connect-section" class="section active text-center">
            <h1 class="text-3xl font-bold mb-6 text-white">VaultChain: Ultra-Secure Access Control</h1>
            <p class="mb-8 text-lg text-gray-400">Please connect your MetaMask wallet to begin.</p>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                <button id="connect-metamask-btn" class="px-8 py-3 text-xl">Connect MetaMask</button>
                <button id="logout-btn" class="secondary px-6 py-3 text-lg hidden">Logout & Reset</button>
            </div>
            <div id="metamask-status" class="message-box mt-6 hidden"></div>
        </div>

        <!-- Email Registration -->
        <div id="email-registration-section" class="section text-center">
            <h2 class="text-2xl font-bold mb-6 text-white">Register Your Email</h2>
            <p class="mb-4 text-gray-400">Enter a valid email address to link to your blockchain identity.</p>
            <input type="email" id="registration-email-input" placeholder="Enter your email" class="mb-4 mt-6">
            <button id="submit-email-btn">Submit Email</button>
            <div id="email-registration-status" class="message-box mt-4 hidden"></div>
        </div>

        <!-- Device Registration -->
        <div id="device-registration-section" class="section text-center">
            <h2 class="text-2xl font-bold mb-6 text-white">System Registration</h2>
            <p class="mb-4 text-gray-400">Registering your system and binding it to your identity...</p>
            <div class="spinner mb-4"></div>
            <div id="device-reg-status" class="message-box mt-6 hidden"></div>
        </div>

        <!-- Login and Recovery Flows -->
        <div id="vaultchain-login" class="section text-center">
            <h2 class="text-2xl font-bold mb-6 text-white">VaultChain: Secure Login</h2>
            
            <div id="keyword-login-section">
                <p class="mb-4 text-gray-400">A unique 4-word phrase has been sent to your registered email. Please enter it below.</p>
                <input type="text" id="keyword-phrase-input" placeholder="Enter 4-word phrase from your email" class="mb-4 mt-6">
                <button id="submit-keyword-btn">Submit Phrase</button>
                <div id="keyword-login-status" class="message-box mt-4 hidden"></div>
            </div>
            
            <div id="recovery-options-section" class="hidden">
                <p class="mb-4 text-gray-400">Login failed. Choose a recovery option (1 attempt only).</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="biometric-recovery-btn">OTP Recovery</button>
                    <button id="admin-recovery-btn" class="secondary">Admin Help (Simulated)</button>
                </div>
                <div id="recovery-status" class="message-box mt-4 hidden"></div>
            </div>
            
            <div id="biometric-flow-section" class="hidden">
                <h3 class="text-xl font-bold mb-4 text-white">OTP Recovery</h3>
                <p class="mb-4 text-gray-400">An OTP has been sent to your registered email. Please enter it below.</p>
                <input type="text" id="biometric-otp-input" placeholder="Enter OTP from your email" class="mb-4 mt-6">
                <button id="verify-biometric-btn">Verify OTP</button>
                <div id="biometric-status" class="message-box mt-4 hidden"></div>
            </div>

            <div id="admin-flow-section" class="hidden">
                <h3 class="text-xl font-bold mb-4 text-white">Admin Intervention (Simulated)</h3>
                <p class="mb-4 text-gray-400">A request has been sent to the admin. For this demo, we will simulate the outcome.</p>
                <button id="request-admin-btn">Simulate Admin Verification</button>
                <div id="admin-status" class="message-box mt-4 hidden"></div>
            </div>
        </div>

        <!-- Blocked Account Screens -->
        <div id="blocked-forever-section" class="section text-center">
            <h3 class="text-xl font-bold mb-4 text-white">System Permanently Blocked</h3>
            <p class="mb-4 text-gray-400">Your account is permanently blocked due to critical security violations.</p>
            <button id="blocked-forever-back-to-home-btn" class="secondary">Reset Application</button>
        </div>
        <div id="blocked-for-day-section" class="section text-center">
            <h3 class="text-xl font-bold mb-4 text-white">Access Blocked for the Day</h3>
            <p class="mb-4 text-gray-400">Your access is temporarily blocked due to suspicious activity.</p>
            <button id="blocked-for-day-back-to-home-btn" class="secondary">Reset Application</button>
        </div>
    </div>
<script>
    // --- JAVASCRIPT LOGIC ---
    const API_URL = 'http://localhost:3000';
    const METAMASK_URL = 'https://portfolio.metamask.io/';

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
    }

    function displayMessage(elementId, message, type = 'info') {
        const el = document.getElementById(elementId);
        el.innerHTML = message;
        el.className = `message-box mt-4 ${type}`;
        el.classList.remove('hidden');
    }

    // State is managed in localStorage to persist across page reloads
    let state = {
        isMetaMaskConnected: localStorage.getItem('isMetaMaskConnected') === 'true',
        isDeviceRegistered: localStorage.getItem('isDeviceRegistered') === 'true',
        isLoggedIn: localStorage.getItem('isLoggedIn') === 'true',
        isPermanentlyBlocked: localStorage.getItem('isPermanentlyBlocked') === 'true',
        isTemporarilyBlocked: localStorage.getItem('isTemporarilyBlocked') === 'true',
        lastAdminRequestDate: localStorage.getItem('lastAdminRequestDate'),
        registeredEmail: localStorage.getItem('registeredEmail') || "",
        hasAttemptedRecovery: localStorage.getItem('hasAttemptedRecovery') === 'true',
        // In-memory secrets received from the backend
        currentPhrase: "",
        currentOtp: ""
    };

    const setState = (key, value) => {
        state[key] = value;
        localStorage.setItem(key, String(value));
    };

    // --- CORE APPLICATION FLOW ---

    // 1. MetaMask Connection
    document.getElementById('connect-metamask-btn').addEventListener('click', async () => {
        if (!window.ethereum) return displayMessage('metamask-status', 'MetaMask is not installed.', 'error');
        try {
            displayMessage('metamask-status', '<div class="spinner"></div> Connecting...', 'info');
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            setState('isMetaMaskConnected', true);
            routeUserAfterConnection();
        } catch (error) {
            displayMessage('metamask-status', `Connection failed: ${error.message}`, 'error');
        }
    });

    // 2. User Routing
    function routeUserAfterConnection() {
        // Handle blocks first
        if (state.isPermanentlyBlocked) return showSection('blocked-forever-section');
        const today = new Date().toISOString().slice(0, 10);
        if (state.isTemporarilyBlocked && state.lastAdminRequestDate === today) return showSection('blocked-for-day-section');
        
        // If already logged in, redirect to MetaMask
        if (state.isLoggedIn) {
            displayMessage('metamask-status', 'Already logged in. Redirecting to MetaMask Portfolio...', 'success');
            setTimeout(() => { window.location.href = METAMASK_URL; }, 1500);
            return;
        }

        if (state.registeredEmail && state.isDeviceRegistered) return startLoginFlow();
        showSection('email-registration-section');
    }

    // 3. Email & Device Registration
    document.getElementById('submit-email-btn').addEventListener('click', () => {
        const email = document.getElementById('registration-email-input').value.trim();
        if (!email.includes('@')) return displayMessage('email-registration-status', 'Please enter a valid email.', 'error');
        setState('registeredEmail', email);
        displayMessage('email-registration-status', 'Email registered! Registering device...', 'success');
        setTimeout(() => {
            showSection('device-registration-section');
            setState('isDeviceRegistered', true);
            displayMessage('device-reg-status', 'Device registered!', 'success');
            setTimeout(startLoginFlow, 1500);
        }, 2000);
    });

    // 4. Login Flow
    async function startLoginFlow() {
        showSection('vaultchain-login');
        document.getElementById('keyword-login-section').classList.remove('hidden');
        document.getElementById('recovery-options-section').classList.add('hidden');
        document.getElementById('biometric-flow-section').classList.add('hidden');
        displayMessage('keyword-login-status', '<div class="spinner"></div> Sending login phrase to your email...', 'info');

        try {
            const response = await fetch(`${API_URL}/send-phrase`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: state.registeredEmail })
            });
            const data = await response.json();
            if (!data.success) throw new Error(data.message);
            state.currentPhrase = data.phrase; // Store the phrase sent via email
            displayMessage('keyword-login-status', `An email has been sent to ${state.registeredEmail}. Please enter the phrase.`, 'success');
        } catch (error) {
            displayMessage('keyword-login-status', `Error: ${error.message}`, 'error');
        }
    }

    // 5. Keyword Submission
    document.getElementById('submit-keyword-btn').addEventListener('click', () => {
        const phrase = document.getElementById('keyword-phrase-input').value.trim().toLowerCase();
        if (phrase === state.currentPhrase) {
            displayMessage('keyword-login-status', 'Success! Redirecting to MetaMask Portfolio...', 'success');
            setState('isLoggedIn', true);
            setTimeout(() => { window.location.href = METAMASK_URL; }, 1500);
        } else {
            document.getElementById('keyword-login-section').classList.add('hidden');
            document.getElementById('recovery-options-section').classList.remove('hidden');
        }
    });

    // --- RECOVERY FLOWS ---

    // OTP Recovery
    document.getElementById('biometric-recovery-btn').addEventListener('click', async () => {
        if (state.hasAttemptedRecovery) return displayMessage('recovery-status', 'You have already used your recovery attempt.', 'error');
        
        document.getElementById('recovery-options-section').classList.add('hidden');
        document.getElementById('biometric-flow-section').classList.remove('hidden');
        displayMessage('biometric-status', '<div class="spinner"></div> Sending OTP to your email...', 'info');
        
        try {
            const response = await fetch(`${API_URL}/send-otp`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: state.registeredEmail })
            });
            const data = await response.json();
            if (!data.success) throw new Error(data.message);
            state.currentOtp = data.otp; // Store the OTP sent via email
            setState('hasAttemptedRecovery', true);
            displayMessage('biometric-status', `An OTP has been sent to ${state.registeredEmail}.`, 'success');
        } catch (error) {
            displayMessage('biometric-status', `Error: ${error.message}`, 'error');
        }
    });

    // Verify OTP
    document.getElementById('verify-biometric-btn').addEventListener('click', () => {
        const otp = document.getElementById('biometric-otp-input').value;
        if (otp === state.currentOtp) {
            displayMessage('biometric-status', 'OTP verified! Redirecting to MetaMask Portfolio...', 'success');
            setState('isLoggedIn', true);
            setTimeout(() => { window.location.href = METAMASK_URL; }, 1500);
        } else {
            displayMessage('biometric-status', 'Incorrect OTP. System permanently blocked.', 'error');
            setState('isPermanentlyBlocked', true);
            setTimeout(() => showSection('blocked-forever-section'), 1500);
        }
    });

    // Admin Recovery (Simulated)
    document.getElementById('admin-recovery-btn').addEventListener('click', () => {
        document.getElementById('recovery-options-section').classList.add('hidden');
        document.getElementById('admin-flow-section').classList.remove('hidden');
    });

    document.getElementById('request-admin-btn').addEventListener('click', () => {
        const adminTrusts = Math.random() < 0.7; // 70% chance of success
        if (adminTrusts) {
            displayMessage('admin-status', 'Admin verified request. Redirecting to MetaMask Portfolio...', 'success');
            setState('isLoggedIn', true);
            setTimeout(() => { window.location.href = METAMASK_URL; }, 1500);
        } else {
            displayMessage('admin-status', 'Admin denied access. Blocked for the day.', 'error');
            setState('isTemporarilyBlocked', true);
            setState('lastAdminRequestDate', new Date().toISOString().slice(0, 10));
            setTimeout(() => showSection('blocked-for-day-section'), 1500);
        }
    });

    // --- SESSION AND CLEANUP ---
    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.clear();
        location.reload();
    });
    
    const resetApp = () => { localStorage.clear(); location.reload(); };
    document.getElementById('blocked-forever-back-to-home-btn').addEventListener('click', resetApp);
    document.getElementById('blocked-for-day-back-to-home-btn').addEventListener('click', resetApp);

    // Initial Load
    window.onload = () => {
        // Show logout button if user has any saved state
        if (state.isMetaMaskConnected || state.registeredEmail) {
            document.getElementById('logout-btn').classList.remove('hidden');
        }

        if (state.isMetaMaskConnected) {
            routeUserAfterConnection();
        } else {
            showSection('metamask-connect-section');
        }
    };
</script>
</body>
</html>
